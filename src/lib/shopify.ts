const ADMIN_TOKEN=process.env.SHOPIFY_ADMIN_TOKEN!; const STORE_DOMAIN=process.env.SHOPIFY_STORE_DOMAIN!; const NS=process.env.SHOPIFY_CREDIT_NAMESPACE||'cfg'; const KEY=process.env.SHOPIFY_CREDIT_KEY||'store_credit_cents'; const base=`https://${STORE_DOMAIN}/admin/api/2024-10`; export async function shopifyAdmin(p:string,init?:RequestInit){const r=await fetch(`${base}${p}`,{...init,headers:{'X-Shopify-Access-Token':ADMIN_TOKEN,'Content-Type':'application/json',...(init?.headers||{})},cache:'no-store'}); if(!r.ok) throw new Error(`Shopify ${p} ${r.status}: ${await r.text()}`); return r.json();} export async function setCustomerCreditCents(id:number|string,cents:number){const m=await shopifyAdmin(`/customers/${id}/metafields.json`); const ex=(m?.metafields||[]).find((x:any)=>x.namespace===NS&&x.key===KEY); if(ex){return (await shopifyAdmin(`/metafields/${ex.id}.json`,{method:'PUT',body:JSON.stringify({metafield:{id:ex.id,value:String(cents),type:'number_integer'}})})).metafield;} else {return (await shopifyAdmin(`/metafields.json`,{method:'POST',body:JSON.stringify({metafield:{namespace:NS,key:KEY,type:'number_integer',value:String(cents),owner_resource:'customer',owner_id:id}})})).metafield;}}
